<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Luan</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>

     <link rel="stylesheet" href="styles.css">
</head>
<body>
    <form id="chat">
        <input type="hidden" id="nome" name="username" placeholder="Nome de Usuario">
        <div class="pessoasConectadas"></div>
        <input type="file" id="fileInput"><div class="messages" id="messages"></div>
        <div class="pessoasDigitando"></div>
        <input type="text" id='msg' name="message" placeholder="Mensagem...">
        <button type="submit">Enviar</button>


    </form>

    <script type="text/javascript">
        var conexoes = [];
        var pessoasDigitando = [];
        var ultimoAEnviar = "";
        
        function getQueryString() {
            var result = {}, queryString = location.search.slice(1),
                re = /([^&=]+)=([^&]*)/g, m;

            while (m = re.exec(queryString)) {
                result[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }

            return result;
        }

        var nome = getQueryString()["username"];
        //alert("Logado como: "+nome);
        document.getElementById('nome').value = nome;

        // var socket = io('http://18.230.130.206:3000/');
        var socket = io('http://localhost:3000/');

        function scroll(limit){
            const out = document.getElementById("messages")
            //se esta no bottom da div
            const isScrolledToBottom = out.scrollHeight - out.clientHeight <= out.scrollTop + limit

            if (isScrolledToBottom) {
                //setta o scroll
                out.scrollTop = out.scrollHeight - out.clientHeight
            }
        }

        function renderMessage(message) {
            var scrollLimit = 120
            if (message.id == socket.id){
                if (message.msg){
                    $('.messages').append('<div class="messageEnviada">'+message.msg+'</div>')
                }
                else{
                    scrollLimit = 450
                    $('.messages').append('<div class="messageEnviada">'+message.msg+'</div>')
                }
            }
            else{
                if (ultimoAEnviar != message.nome){
                    $('.messages').append('<div><strong>'+ message.nome +'</strong>: </div>')
                }
                if (message.msg){
                    $('.messages').append('<div class="message">'+message.msg+'</div>')
                }
                else{
                    scrollLimit = 450
                    $('.messages').append('<div class="messageImg"> <img class="img" style="border-radius: 10px;" src="data:image/png;base64,'+message.img+'" alt="Red dot" /> </div>')
                    
                }
                $('.messages').append('<br>')
            }
            ultimoAEnviar = message.nome;
            scroll(scrollLimit)
            
        }

        function atualizarPessoasDigitando(){
            $('.pessoasDigitandoAtual').remove();
            var str = "";
            if (pessoasDigitando.length == 0){
                return false;
            }
            if (pessoasDigitando.length > 4){
                str = "Diversas pessoas estão digitando...";
            }
            else{
                pessoasDigitando.forEach(element => {
                    if (str){
                        str =  str + ",";
                    }
                    str += element;
                });
                if (pessoasDigitando.length == 1){
                        str = str + " está digitando...";
                    }
                    else{
                        str = str + " estão digitando...";
                    }
            }
            $('.pessoasDigitando').append('<div class="pessoasDigitandoAtual">'+str+'</div>')
        }

        function atualizarPessoasOnline(){
            $('.pessoasOnline').remove();
            var str = "Voce ";
            conexoes.forEach(element => {
                if (str){
                    str =  str + ",";
                }
                str += element.nome;
            });
            $('.pessoasConectadas').append('<div class="pessoasOnline">'+str+'</div>')
            scroll(80)
        }


        socket.on('mensagemRecebida', function(message){
            renderMessage(message)
        })

        socket.on('conexoesAnteriores', function(messages){
            for (message of messages){
                conexoes.push(message)
            }
            atualizarPessoasOnline()
        })

        socket.on('novaConexao', function(message){
            conexoes.push(message)
            $('.messages').append('<div class="novoUsuario">'+message.nome+' Entrou </div>')
            atualizarPessoasOnline()
        })

        socket.on('desconectado', function(message){
            const element = conexoes.find(item => item == message)
            var i = conexoes.indexOf(element);
            conexoes.splice(i, 1);
            $('.messages').append('<div class="novoUsuario">'+message.nome+' Saiu </div>')
            atualizarPessoasOnline()
        })

        socket.on('digitando', function(message){
            pessoasDigitando.push(message.nome);
            atualizarPessoasDigitando()
        })

        socket.on('parouDigitar', function(message){
            const element = pessoasDigitando.find(item => item == message.nome)
            var i = pessoasDigitando.indexOf(element);
            pessoasDigitando.splice(i, 1);
            atualizarPessoasDigitando()
        })


        socket.on('connect', function(message){
            var id = socket.id;
            var object = {
                    nome, 
                    id,
                };
                socket.emit('conectar', object);
        })

        socket.on('mensagensAnteriores', function(messages){
            for (message of messages){
                renderMessage(message)
            }
            const out = document.getElementById("messages")
            out.scrollTop = out.scrollHeight - out.clientHeight
            
        })

        $('#chat').submit(function(event) {
            event.preventDefault();

            var msg = $('input[name=message').val();
            var id = socket.id;

            if (nome.length){
                getBase64().then(
                    data => alert(data)
                );
                if (msg.length){
                    var object = {
                        nome, 
                        msg,
                        id,
                    };
                }
                else if (stringToBase64()){
                    const img = stringToBase64()
                    var object = {
                        nome, 
                        img,
                        id,
                    };
                }
                
                renderMessage(object);
                socket.emit('enviarMensagem', object);
            }
            doneTyping()
            document.getElementById('msg').value = null;
        })

        var digitando = false;
        var typingTimer;                //timer identifier
        var doneTypingInterval = 5000;  //time in ms, 5 second for example
        var $input = $('#msg');

        //on keyup, start the countdown
        $input.on('keyup', function () {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(doneTyping, doneTypingInterval);

            var id = socket.id;
            var object = {
                nome, 
                id,
            };
            if (!digitando){
                socket.emit('digitando', object);
                digitando = true;
            }

        });

        //on keydown, clear the countdown 
        $input.on('keydown', function () {
            clearTimeout(typingTimer);
        });

        //user is "finished typing," do something
        function doneTyping () {
            var id = socket.id;
            var object = {
                nome, 
                id,
            };
            socket.emit('parouDigitar', object);
            digitando = false;
        }

        function stringToBase64(){
            var fileInput = document.getElementById('fileInput');

            var reader = new FileReader();
            reader.readAsDataURL(fileInput.files[0]);

            reader.onload = function () {
                console.log(reader.result);//base64encoded string
                return reader.result;
            };
            reader.onerror = function (error) {
                console.log('Error: ', error);
                return false;
            };
        }

        function getBase64() {
            alert('Base64')
            var file = document.querySelector('#files > input[type="file"]').files[0];
            return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
}
    </script>
</body>
</html>